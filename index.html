<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Rei - Nivel 1</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
  <style>
    body { margin: 0; padding: 0; overflow: hidden; background: #fff; touch-action: none; }
    canvas { image-rendering: pixelated; display: block; }
  </style>
</head>
<body>
<script>

let xPos, yPos, size = 30;
let baseVel = 3.8, vel = baseVel, rotAngle = 0;
let gotas = [], cantidadGotas = 35;
let triangulos = [], numTriangulosBloque = 10, totalComidas = 40, comidasHechas = 0;
let vida = 100, gatitoWin, gatitoLose, gatitoSize;
let ganado = false, perdido = false, dificultad = 1, particulas = [];
let escalaMovil = 1, esMovil = false;
let btnSize = 55; // Aprox 1cm en pantallas estándar

function preload() {
  // Asegúrate de que estos archivos existan en tu repo de GitHub
  gatitoWin = loadImage('rei.jpg');
  gatitoLose = loadImage('rei2.jpg');
}

function setup() {
  createCanvas(windowWidth, windowHeight);
  noSmooth();

  esMovil = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  if(esMovil) escalaMovil = 1.5;

  size *= escalaMovil;
  gatitoSize = 150 * escalaMovil;
  xPos = width/2;
  yPos = height/2;

  iniciarBloque();

  for(let i=0; i<cantidadGotas; i++){
    gotas.push({
      x: random(width), y: random(-500,0),
      r: random(10,20)*escalaMovil,
      speed: random(1.2,2.8), wave: random(0.5,2)
    });
  }
}

function iniciarBloque(){
  triangulos = [];
  for(let i=0; i<numTriangulosBloque; i++){
    triangulos.push({
      centerX: random(50, width-50),
      centerY: random(50, height-150),
      angle: random(TWO_PI),
      radius: random(30,60)*escalaMovil,
      size: random(22,34)*escalaMovil,
      speed: random(0.015,0.035)*dificultad
    });
  }
}

function reiniciarJuego(){
  comidasHechas = 0; vida = 100; dificultad = 1;
  ganado = false; perdido = false;
  iniciarBloque();
  xPos = width/2; yPos = height/2;
}

function draw(){
  background(255);

  if(!ganado && !perdido){
    let enLiquido = false;

    // Gotas
    noStroke(); fill(0,255,0, 150);
    for(let g of gotas){
      g.y += g.speed * dificultad;
      g.x += sin(frameCount*0.02 + g.y)*g.wave;
      ellipse(g.x, g.y, g.r*1.2, g.r*1.8);
      if(g.y > height+20){ g.y=random(-200,0); g.x=random(width); }
      if(dist(xPos, yPos, g.x, g.y) < size/2 + g.r/2) enLiquido = true;
    }

    vel = enLiquido ? baseVel*0.5 : baseVel;
    if(enLiquido){
      vida -= 0.08; // Vida dura mucho más
      if(vida <= 0){ vida=0; perdido=true; }
    }

    let dx=0, dy=0;

    // Controles PC
    if(keyIsDown(LEFT_ARROW)||keyIsDown(65)) dx -= 1;
    if(keyIsDown(RIGHT_ARROW)||keyIsDown(68)) dx += 1;
    if(keyIsDown(UP_ARROW)||keyIsDown(87)) dy -= 1;
    if(keyIsDown(DOWN_ARROW)||keyIsDown(83)) dy += 1;

    // Controles Móvil (Botones Azules Solicitados)
    if(esMovil) {
      drawMobileControls();
      for(let t of touches) {
        if(t.x < btnSize + 40 && t.y > height - btnSize - 40) dx = -1;
        if(t.x > width - btnSize - 40 && t.y > height - btnSize - 40) dx = 1;
        if(t.y < height/2) dy = -1;
        if(t.y > height/2 && t.y < height - 100) dy = 1;
      }
    }

    xPos += dx*vel; yPos += dy*vel;
    xPos = constrain(xPos, size/2, width-size/2);
    yPos = constrain(yPos, size/2, height-size/2);

    // Triángulos Invertidos
    fill(255,0,0);
    for(let i=triangulos.length-1; i>=0; i--){
      let t = triangulos[i]; t.angle += t.speed;
      let tx = t.centerX + cos(t.angle)*t.radius;
      let ty = t.centerY + sin(t.angle)*t.radius;
      triangle(tx, ty + t.size/2, tx - t.size/2, ty - t.size/2, tx + t.size/2, ty - t.size/2);
      if(dist(xPos, yPos, tx, ty) < size/2 + t.size/2){
        for(let p=0; p<10; p++) particulas.push({x:tx, y:ty, vx:random(-2,2), vy:random(-2,2), a:255});
        triangulos.splice(i,1);
        comidasHechas++;
      }
    }

    // Partículas
    for(let i=particulas.length-1; i>=0; i--){
      let p=particulas[i]; p.x+=p.vx; p.y+=p.vy; p.a-=6;
      fill(255,0,0,p.a); ellipse(p.x, p.y, 4);
      if(p.a<=0) particulas.splice(i,1);
    }

    if(triangulos.length===0 && comidasHechas < totalComidas){
      dificultad += 0.1;
      iniciarBloque();
    }

    // Cubo Rei
    push(); translate(xPos, yPos); rotate(rotAngle += 0.1);
    rectMode(CENTER); fill(0); rect(0,0,size,size); pop();

    // UI
    noStroke();
    fill(255,0,0); rect(20,20,(vida/100)*150,12);
    fill(0,200,0); rect(20,40,(comidasHechas/totalComidas)*150,12);

    if(comidasHechas >= totalComidas) ganado = true;

  } else {
    // Pantalla de Fin
    background(255);
    imageMode(CENTER);
    image(ganado ? gatitoWin : gatitoLose, width/2, height/2-40, gatitoSize, gatitoSize);
    textAlign(CENTER); fill(0);
    text("HAZ CLICK EN LA IMAGEN PARA REINICIAR", width/2, height/2 + gatitoSize/2 + 20);
  }
}

function drawMobileControls() {
  rectMode(CENTER);
  stroke(0, 50);
  // Izquierda
  fill(0, 100, 255);
  rect(btnSize, height - btnSize, btnSize, btnSize, 12);
  fill(255); ellipse(btnSize, height - btnSize, btnSize/2);
  // Derecha
  fill(0, 100, 255);
  rect(width - btnSize, height - btnSize, btnSize, btnSize, 12);
  fill(255); ellipse(width - btnSize, height - btnSize, btnSize/2);
}

function mousePressed() {
  if ((ganado || perdido) && dist(mouseX, mouseY, width/2, height/2) < gatitoSize) {
    reiniciarJuego();
  }
}

function touchStarted() {
  if (ganado || perdido) {
    if(dist(touches[0].x, touches[0].y, width/2, height/2) < gatitoSize) reiniciarJuego();
  }
  return false;
}

function windowResized(){ resizeCanvas(windowWidth, windowHeight); }

</script>
</body>
</html>