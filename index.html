<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Rei - Nivel 1</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
</head>
<body>
<script>
let xPos, yPos;
let size = 30;
let baseVel = 3, vel = baseVel, rotAngle = 0;
let gotas = [], cantidadGotas = 35;
let triangulos = [], numTriangulosBloque = 10;
let totalComidas = 50;
let comidasHechas = 0;
let vida = 100;
let gatito, gatitoX, gatitoY, gatitoSize;
let ganado = false;
let perdido = false;
let dificultad = 1;
let particulas = [];

// joystick visual
let joystick = {x:0, y:0, r:60, active:false, touchX:0, touchY:0, offsetX:0, offsetY:0};

// Factor de escala en móvil
let escalaMovil = 1;

function preload() {
  gatito = loadImage('rei.jpg');
}

function setup() {
  createCanvas(windowWidth, windowHeight);

  // detectar móvil y ajustar escala
  if(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)){
    escalaMovil = 1.5;
  }

  size *= escalaMovil;
  gatitoSize = 120 * escalaMovil;

  xPos = width/2;
  yPos = height/2;
  gatitoX = width/2;
  gatitoY = height/2 - gatitoSize;

  reiniciarBloque();

  // inicializar gotas verdes
  gotas = [];
  for(let i=0;i<cantidadGotas;i++){
    gotas.push({
      x: random(width),
      y: random(-500,0),
      r: random(10,20)*escalaMovil,
      speed: random(1,2.5),
      wave: random(0.5,2)
    });
  }

  // posición joystick
  joystick.x = width/2;
  joystick.y = height - 100*escalaMovil;
  joystick.touchX = joystick.x;
  joystick.touchY = joystick.y;
}

function reiniciarBloque(){
  triangulos = [];
  for(let i=0;i<numTriangulosBloque;i++){
    triangulos.push({
      x: random(100,width-100),
      y: random(100,height-100),
      size: random(20,35)*escalaMovil,
      centerX: random(100,width-100),
      centerY: random(100,height-100),
      angle: random(TWO_PI),
      radius: random(30,60)*escalaMovil,
      speed: random(0.01,0.03)*dificultad
    });
  }
}

function reiniciarJuego(){
  comidasHechas = 0;
  vida = 100;
  dificultad = 1;
  ganado = false;
  perdido = false;
  reiniciarBloque();
  joystick.touchX = joystick.x;
  joystick.touchY = joystick.y;
  joystick.active = false;
}

function draw(){
  background(255);

  if(!ganado && !perdido){
    let enLiquido = false;

    // gotas verdes
    noStroke(); fill(0,255,0);
    for(let g of gotas){
      g.y += g.speed * dificultad;
      g.x += sin(frameCount*0.02 + g.y)*g.wave;
      ellipse(g.x,g.y,g.r*1.2,g.r*1.8);
      if(g.y>height+20){ g.y=random(-200,0); g.x=random(width);}
      if(dist(xPos,yPos,g.x,g.y) < size/2 + g.r/2) enLiquido=true;
    }

    vel = enLiquido ? baseVel*0.5 : baseVel;
    if(enLiquido){ vida -= 0.45; if(vida<=0){ vida=0; perdido=true; } }

    // movimiento teclado
    let dx = 0, dy = 0;
    if(keyIsDown(LEFT_ARROW)||keyIsDown(65)) dx -= 1;
    if(keyIsDown(RIGHT_ARROW)||keyIsDown(68)) dx += 1;
    if(keyIsDown(UP_ARROW)||keyIsDown(87)) dy -= 1;
    if(keyIsDown(DOWN_ARROW)||keyIsDown(83)) dy += 1;

    // movimiento joystick
    if(joystick.active){
      let offsetX = joystick.touchX - joystick.x;
      let offsetY = joystick.touchY - joystick.y;
      let distMag = dist(joystick.touchX, joystick.touchY, joystick.x, joystick.y);
      let maxMag = joystick.r;
      if(distMag > maxMag){
        let angle = atan2(offsetY, offsetX);
        offsetX = cos(angle)*maxMag;
        offsetY = sin(angle)*maxMag;
      }
      joystick.offsetX = offsetX;
      joystick.offsetY = offsetY;
      dx += offsetX / maxMag;
      dy += offsetY / maxMag;
    }

    xPos += dx*vel;
    yPos += dy*vel;

    // mantener dentro del canvas
    xPos = constrain(xPos, size/2, width - size/2);
    yPos = constrain(yPos, size/2, height - size/2);

    // triángulos rojos invertidos
    fill(255,0,0); noStroke();
    for(let i=triangulos.length-1;i>=0;i--){
      let t = triangulos[i];
      t.angle += t.speed;
      t.x = t.centerX + cos(t.angle)*t.radius;
      t.y = t.centerY + sin(t.angle)*t.radius;

      triangle(
        t.x, t.y + t.size/2,
        t.x - t.size/2, t.y - t.size/2,
        t.x + t.size/2, t.y - t.size/2
      );

      if(dist(xPos,yPos,t.x,t.y) < size/2 + t.size/2){
        for(let p=0;p<15;p++){
          particulas.push({
            x:t.x, y:t.y,
            vx:random(-2,2), vy:random(-2,2),
            alpha:255, size:random(3,6)
          });
        }
        triangulos.splice(i,1);
        comidasHechas++;
      }
    }

    // partículas
    for(let i=particulas.length-1;i>=0;i--){
      let p=particulas[i];
      p.x+=p.vx; p.y+=p.vy;
      p.alpha-=5;
      fill(255,0,0,p.alpha);
      noStroke();
      ellipse(p.x,p.y,p.size);
      if(p.alpha<=0) particulas.splice(i,1);
    }

    if(triangulos.length===0 && comidasHechas<totalComidas){
      dificultad += 0.1;
      reiniciarBloque();
    }

    // cuadrado negro girando
    rotAngle += 0.1;
    push(); translate(xPos,yPos); rotate(rotAngle); rectMode(CENTER); fill(0); rect(0,0,size,size); pop();

    // barras
    fill(0,200,0); rect(20,20,(vida/100)*200*escalaMovil,20*escalaMovil); // vida
    fill(255,0,0); rect(20,50,(comidasHechas/totalComidas)*200*escalaMovil,20*escalaMovil); // comida

    // dibujar joystick
    if(escalaMovil>1){
      drawJoystick(joystick);
    }

    if(comidasHechas>=totalComidas) ganado=true;

  } else if(ganado){
    background(255);
    push();
    imageMode(CENTER);
    let alpha = map(sin(frameCount*0.05),-1,1,100,255);
    tint(150,150,150,alpha);
    image(gatito, gatitoX, gatitoY, gatitoSize*1.2, gatitoSize*1.2);
    pop();
    textAlign(CENTER,CENTER);
    textSize(48*escalaMovil); fill(0,200,0);
    text('勝った！', width/2, height/2 + 50);
    textSize(32*escalaMovil); fill(0);
    text('Play', width/2, height/2 + 120);
  } else if(perdido){
    background(255);
    textAlign(CENTER,CENTER);
    textSize(48*escalaMovil); fill(255,0,0);
    text('負けた！', width/2, height/2);
    textSize(32*escalaMovil); fill(0);
    text('Play', width/2, height/2 + 80);
  }
}

function drawJoystick(j){
  fill(50,100,200,150);
  noStroke();
  rectMode(CENTER);
  rect(j.x,j.y,j.r*2,j.r*2,10); // cuadro joystick
  fill(50,150,255,200);
  ellipse(j.x+j.offsetX,j.y+j.offsetY,j.r); // círculo que se mueve
}

// ------------------ TOUCH CONTROL ------------------
function touchStarted(){
  if(ganado || perdido) reiniciarJuego();
  for(let i=0;i<touches.length;i++){
    if(dist(touches[i].x,touches[i].y,joystick.x,joystick.y)<joystick.r*1.5 && !joystick.active){
      joystick.active=true;
      joystick.touchX=touches[i].x;
      joystick.touchY=touches[i].y;
    }
  }
}

function touchMoved(){
  for(let i=0;i<touches.length;i++){
    if(joystick.active){
      joystick.touchX = touches[i].x;
      joystick.touchY = touches[i].y;
    }
  }
  return false;
}

function touchEnded(){
  joystick.active=false;
  joystick.offsetX=0;
  joystick.offsetY=0;
}
// ------------------------------------------------------

function windowResized(){ 
  resizeCanvas(windowWidth, windowHeight);
  joystick.x = width/2;
  joystick.y = height - 100*escalaMovil;
  joystick.touchX = joystick.x;
  joystick.touchY = joystick.y;
}

</script>
</body>
</html>
