<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Rei - Nivel 1</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
</head>
<body>
<script>
let xPos, yPos;
let size = 30;
let baseVel = 5; // MÁS VELOCIDAD REAL
let vel = baseVel, rotAngle = 0;
let gotas = [], cantidadGotas = 35;
let triangulos = [], numTriangulosBloque = 10;
let totalComidas = 50;
let comidasHechas = 0;
let vida = 100;
let gatito, perderImg;
let ganado = false;
let perdido = false;
let dificultad = 1;
let particulas = [];

// dos joysticks
let joyV = {x:0,y:0,r:40,active:false,offsetY:0};
let joyH = {x:0,y:0,r:40,active:false,offsetX:0};

let escalaMovil = 1;

function preload(){
  gatito = loadImage('rei.jpg');
  perderImg = loadImage('rei2.jpg');
}

function setup(){
  createCanvas(windowWidth, windowHeight);

  if(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)){
    escalaMovil = 1.4;
  }

  size *= escalaMovil;
  xPos = width/2;
  yPos = height/2;

  joyV.x = width*0.3;
  joyH.x = width*0.7;
  joyV.y = joyH.y = height - 90*escalaMovil;

  reiniciarBloque();

  for(let i=0;i<cantidadGotas;i++){
    gotas.push({
      x: random(width),
      y: random(-500,0),
      r: random(10,20)*escalaMovil,
      speed: random(1,2.2),
      wave: random(0.5,2)
    });
  }
}

function reiniciarBloque(){
  triangulos=[];
  for(let i=0;i<numTriangulosBloque;i++){
    triangulos.push({
      x: random(100,width-100),
      y: random(100,height-100),
      size: random(20,35)*escalaMovil,
      cx: random(100,width-100),
      cy: random(100,height-100),
      a: random(TWO_PI),
      r: random(30,60)*escalaMovil,
      s: random(0.01,0.025)*dificultad
    });
  }
}

function reiniciarJuego(){
  comidasHechas=0;
  vida=100;
  dificultad=1;
  ganado=false;
  perdido=false;
  reiniciarBloque();
}

function draw(){
  background(255);

  if(!ganado && !perdido){
    let enLiquido=false;

    noStroke(); fill(0,255,0);
    for(let g of gotas){
      g.y+=g.speed*dificultad;
      g.x+=sin(frameCount*0.02+g.y)*g.wave;
      ellipse(g.x,g.y,g.r*1.2,g.r*1.8);
      if(g.y>height){ g.y=random(-200,0); g.x=random(width); }
      if(dist(xPos,yPos,g.x,g.y)<size/2+g.r/2) enLiquido=true;
    }

    vel = enLiquido ? baseVel*0.7 : baseVel;
    if(enLiquido){
      vida -= 0.25; // MÁS LENTO
      if(vida<=0){ vida=0; perdido=true; }
    }

    let dx=0, dy=0;

    if(keyIsDown(LEFT_ARROW)||keyIsDown(65)) dx--;
    if(keyIsDown(RIGHT_ARROW)||keyIsDown(68)) dx++;
    if(keyIsDown(UP_ARROW)||keyIsDown(87)) dy--;
    if(keyIsDown(DOWN_ARROW)||keyIsDown(83)) dy++;

    dx += joyH.offsetX;
    dy += joyV.offsetY;

    xPos += dx*vel;
    yPos += dy*vel;

    xPos = constrain(xPos,size/2,width-size/2);
    yPos = constrain(yPos,size/2,height-size/2);

    fill(255,0,0);
    for(let i=triangulos.length-1;i>=0;i--){
      let t=triangulos[i];
      t.a+=t.s;
      t.x=t.cx+cos(t.a)*t.r;
      t.y=t.cy+sin(t.a)*t.r;

      triangle(t.x,t.y+t.size/2,t.x-t.size/2,t.y-t.size/2,t.x+t.size/2,t.y-t.size/2);

      if(dist(xPos,yPos,t.x,t.y)<size/2+t.size/2){
        triangulos.splice(i,1);
        comidasHechas++;
      }
    }

    if(triangulos.length===0){
      dificultad+=0.1;
      reiniciarBloque();
    }

    rotAngle+=0.1;
    push();
    translate(xPos,yPos);
    rotate(rotAngle);
    rectMode(CENTER);
    fill(0);
    rect(0,0,size,size);
    pop();

    fill(0,200,0); rect(20,20,(vida/100)*200,15);
    fill(255,0,0); rect(20,45,(comidasHechas/totalComidas)*200,15);

    drawJoy(joyV,true);
    drawJoy(joyH,false);

    if(comidasHechas>=totalComidas) ganado=true;
  }

  else if(ganado){
    textAlign(CENTER,CENTER);
    textSize(42);
    fill(0,180,0);
    text("이겼다!",width/2,height/2);
    textSize(28);
    fill(0);
    text("Play",width/2,height/2+70);
  }

  else{
    imageMode(CENTER);
    image(perderImg,width/2,height/2-80,200,200);
    textAlign(CENTER,CENTER);
    textSize(42);
    fill(200,0,0);
    text("졌다!",width/2,height/2+80);
    textSize(28);
    fill(0);
    text("Play",width/2,height/2+130);
  }
}

function drawJoy(j,vertical){
  fill(80,120,200,140);
  rectMode(CENTER);
  rect(j.x,j.y,j.r,j.r,6);
}

function touchStarted(){
  if(ganado||perdido) reiniciarJuego();
  for(let t of touches){
    if(dist(t.x,t.y,joyV.x,joyV.y)<joyV.r){
      joyV.active=true;
    }
    if(dist(t.x,t.y,joyH.x,joyH.y)<joyH.r){
      joyH.active=true;
    }
  }
}

function touchMoved(){
  for(let t of touches){
    if(joyV.active){
      joyV.offsetY = constrain((t.y-joyV.y)/joyV.r,-1,1);
    }
    if(joyH.active){
      joyH.offsetX = constrain((t.x-joyH.x)/joyH.r,-1,1);
    }
  }
  return false;
}

function touchEnded(){
  joyV.active=false; joyH.active=false;
  joyV.offsetY=0; joyH.offsetX=0;
}

function windowResized(){
  resizeCanvas(windowWidth,windowHeight);
  joyV.x = width*0.3;
  joyH.x = width*0.7;
  joyV.y = joyH.y = height - 90*escalaMovil;
}
</script>
</body>
</html>
