<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Rei</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
</head>
<body>
<script>

let xPos, yPos;
let size = 32;
let baseVel = 5; // üî• M√ÅS VELOCIDAD
let vel = baseVel;
let rotAngle = 0;

let gotas = [], cantidadGotas = 35;
let triangulos = [], numTriangulosBloque = 10;
let totalComidas = 50;
let comidas = 0;

let vida = 100;
let ganado = false;
let perdido = false;
let dificultad = 1;

let gatitoWin, gatitoLose;
let escalaMovil = 1;

// ---------- JOYSTICKS ----------
let joySize = 60;
let joyRadius = 20;

let joyV = { x:0, y:0, dx:0, dy:0, activo:false }; // vertical
let joyH = { x:0, y:0, dx:0, dy:0, activo:false }; // horizontal

// ---------- PRELOAD ----------
function preload(){
  gatitoWin = loadImage('rei.jpg');
  gatitoLose = loadImage('rei2.jpg');
}

// ---------- SETUP ----------
function setup(){
  createCanvas(windowWidth, windowHeight);

  if(/Android|iPhone|iPad/i.test(navigator.userAgent)){
    escalaMovil = 1.5;
  }

  size *= escalaMovil;
  joySize *= escalaMovil;
  joyRadius *= escalaMovil;

  xPos = width/2;
  yPos = height/2;

  joyV.x = 80 * escalaMovil;
  joyV.y = height - 120 * escalaMovil;

  joyH.x = width - 80 * escalaMovil;
  joyH.y = height - 120 * escalaMovil;

  initGotas();
  initTriangulos();
}

// ---------- INIT ----------
function initGotas(){
  gotas = [];
  for(let i=0;i<cantidadGotas;i++){
    gotas.push({
      x: random(width),
      y: random(-500,0),
      r: random(12,22)*escalaMovil,
      speed: random(1.5,3),
      wave: random(0.5,2)
    });
  }
}

function initTriangulos(){
  triangulos = [];
  for(let i=0;i<numTriangulosBloque;i++){
    triangulos.push({
      cx: random(100,width-100),
      cy: random(100,height-200),
      angle: random(TWO_PI),
      radius: random(30,70)*escalaMovil,
      size: random(22,36)*escalaMovil,
      speed: random(0.02,0.04)*dificultad
    });
  }
}

// ---------- DRAW ----------
function draw(){
  background(255);

  if(!ganado && !perdido){
    jugar();
  } else {
    pantallaFinal();
  }
}

// ---------- JUEGO ----------
function jugar(){
  let enLiquido = false;

  // gotas verdes
  noStroke(); fill(0,255,0);
  for(let g of gotas){
    g.y += g.speed*dificultad;
    g.x += sin(frameCount*0.02 + g.y)*g.wave;
    ellipse(g.x,g.y,g.r*1.2,g.r*1.8);
    if(g.y>height+20){ g.y=random(-200,0); g.x=random(width); }
    if(dist(xPos,yPos,g.x,g.y) < size/2 + g.r/2) enLiquido=true;
  }

  if(enLiquido){
    vida -= 0.6; // üî• pierde m√°s vida
    vel = baseVel*0.6;
  } else {
    vel = baseVel;
  }

  if(vida <= 0){
    vida = 0;
    perdido = true;
  }

  // teclado PC
  let dx = 0, dy = 0;
  if(keyIsDown(LEFT_ARROW)||keyIsDown(65)) dx -= 1;
  if(keyIsDown(RIGHT_ARROW)||keyIsDown(68)) dx += 1;
  if(keyIsDown(UP_ARROW)||keyIsDown(87)) dy -= 1;
  if(keyIsDown(DOWN_ARROW)||keyIsDown(83)) dy += 1;

  // joystick m√≥vil
  dx += joyH.dx;
  dy += joyV.dy;

  xPos += dx * vel;
  yPos += dy * vel;

  xPos = constrain(xPos, size/2, width-size/2);
  yPos = constrain(yPos, size/2, height-size/2);

  // tri√°ngulos
  fill(255,0,0); noStroke();
  for(let i=triangulos.length-1;i>=0;i--){
    let t = triangulos[i];
    t.angle += t.speed;
    let tx = t.cx + cos(t.angle)*t.radius;
    let ty = t.cy + sin(t.angle)*t.radius;

    triangle(
      tx, ty + t.size/2,
      tx - t.size/2, ty - t.size/2,
      tx + t.size/2, ty - t.size/2
    );

    if(dist(xPos,yPos,tx,ty) < size/2 + t.size/2){
      triangulos.splice(i,1);
      comidas++;
    }
  }

  if(triangulos.length===0 && comidas<totalComidas){
    dificultad += 0.15;
    initTriangulos();
  }

  if(comidas >= totalComidas){
    ganado = true;
  }

  // cuadrado
  rotAngle += 0.12;
  push();
  translate(xPos,yPos);
  rotate(rotAngle);
  rectMode(CENTER);
  fill(0);
  rect(0,0,size,size);
  pop();

  // barras
  fill(0,200,0);
  rect(20,20, vida*2*escalaMovil, 16*escalaMovil);

  fill(255,0,0);
  rect(20,45, (comidas/totalComidas)*200*escalaMovil, 16*escalaMovil);

  dibujarJoysticks();
}

// ---------- JOYSTICKS ----------
function dibujarJoysticks(){
  noFill();
  stroke(0,120,255);
  strokeWeight(2);

  rectMode(CENTER);
  rect(joyV.x,joyV.y,joySize,joySize,10);
  rect(joyH.x,joyH.y,joySize,joySize,10);

  noStroke();
  fill(0,120,255);

  ellipse(joyV.x + joyV.dx*joySize/2, joyV.y + joyV.dy*joySize/2, joyRadius);
  ellipse(joyH.x + joyH.dx*joySize/2, joyH.y + joyH.dy*joySize/2, joyRadius);
}

// ---------- TOUCH ----------
function touchStarted(){
  for(let t of touches){
    if(dist(t.x,t.y,joyV.x,joyV.y) < joySize/2) joyV.activo = true;
    if(dist(t.x,t.y,joyH.x,joyH.y) < joySize/2) joyH.activo = true;
  }
  return false;
}

function touchMoved(){
  for(let t of touches){
    if(joyV.activo){
      joyV.dy = constrain((t.y - joyV.y)/(joySize/2), -1, 1);
    }
    if(joyH.activo){
      joyH.dx = constrain((t.x - joyH.x)/(joySize/2), -1, 1);
    }
  }
  return false;
}

function touchEnded(){
  joyV.dx = joyV.dy = 0;
  joyH.dx = joyH.dy = 0;
  joyV.activo = joyH.activo = false;
}

// ---------- FINAL ----------
function pantallaFinal(){
  background(255);
  imageMode(CENTER);
  tint(150);

  if(ganado){
    image(gatitoWin,width/2,height/2-120*escalaMovil,180*escalaMovil,180*escalaMovil);
    noTint();
    fill(0,200,0);
    textSize(48*escalaMovil);
    textAlign(CENTER,CENTER);
    text('Ïù¥Í≤ºÎã§',width/2,height/2+80);
  }

  if(perdido){
    image(gatitoLose,width/2,height/2-120*escalaMovil,180*escalaMovil,180*escalaMovil);
    noTint();
    fill(255,0,0);
    textSize(48*escalaMovil);
    textAlign(CENTER,CENTER);
    text('Ï°åÎã§',width/2,height/2+80);
  }
}

function windowResized(){
  resizeCanvas(windowWidth, windowHeight);
}

</script>
</body>
</html>
