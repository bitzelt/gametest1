<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Rei - Nivel 1</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
  <style>
    body { margin: 0; overflow: hidden; background: #fff; }
  </style>
</head>
<body>
<script>

let xPos, yPos;
let size = 30;
let baseVel = 3.8, vel = baseVel, rotAngle = 0;

let gotas = [], cantidadGotas = 35;
let triangulos = [];
let numTriangulosBloque = 10;
let totalComidas = 40; // <--- Cambiado a 40
let comidasHechas = 0;

let vida = 100;
let gatitoWin, gatitoLose, gatitoSize;

let ganado = false;
let perdido = false;
let dificultad = 1;
let particulas = [];

// Joystick visual
let joystick = {x:0, y:0, r:70, active:false, offsetX:0, offsetY:0};
let escalaMovil = 1;
let esMovil = false;

function preload() {
  gatitoWin = loadImage('rei.jpg');
  gatitoLose = loadImage('rei2.jpg');
}

function setup() {
  createCanvas(windowWidth, windowHeight);

  esMovil = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  if(esMovil) escalaMovil = 1.5;

  size *= escalaMovil;
  gatitoSize = 250 * escalaMovil;

  xPos = width/2;
  yPos = height/2;

  iniciarBloque();

  for(let i=0; i<cantidadGotas; i++){
    gotas.push({
      x: random(width),
      y: random(-500,0),
      r: random(10,20)*escalaMovil,
      speed: random(1.2,2.8),
      wave: random(0.5,2)
    });
  }

  joystick.r = 60 * escalaMovil;
  joystick.x = width/2;
  joystick.y = height - (joystick.r + 40);
}

function iniciarBloque(){
  triangulos = [];
  // Solo crea más si no hemos llegado a 40
  if (comidasHechas < totalComidas) {
    for(let i=0; i<numTriangulosBloque; i++){
      triangulos.push({
        centerX: random(50, width-50),
        centerY: random(50, height-220),
        angle: random(TWO_PI),
        radius: random(30,60)*escalaMovil,
        size: random(22,34)*escalaMovil,
        speed: random(0.015,0.035)*dificultad
      });
    }
  }
}

function reiniciarJuego(){
  comidasHechas = 0;
  vida = 100;
  dificultad = 1;
  ganado = false;
  perdido = false;
  xPos = width/2;
  yPos = height/2;
  iniciarBloque();
}

function draw(){
  background(255);

  if(!ganado && !perdido){
    let enLiquido = false;

    // Gotas verdes
    noStroke(); fill(0,255,0, 150);
    for(let g of gotas){
      g.y += g.speed * dificultad;
      g.x += sin(frameCount*0.02 + g.y)*g.wave;
      ellipse(g.x, g.y, g.r*1.2, g.r*1.8);
      if(g.y > height+20){ g.y=random(-200,0); g.x=random(width); }
      if(dist(xPos, yPos, g.x, g.y) < size/2 + g.r/2) enLiquido = true;
    }

    vel = enLiquido ? baseVel*0.4 : baseVel;
    if(enLiquido){
      vida -= 0.6;
      if(vida <= 0){ vida=0; perdido=true; }
    }

    let dx=0, dy=0;

    // Control Teclado
    if(keyIsDown(LEFT_ARROW) || keyIsDown(65)) dx -= 1;
    if(keyIsDown(RIGHT_ARROW) || keyIsDown(68)) dx += 1;
    if(keyIsDown(UP_ARROW) || keyIsDown(87)) dy -= 1;
    if(keyIsDown(DOWN_ARROW) || keyIsDown(83)) dy += 1;

    // Joystick corregido
    if(esMovil && joystick.active){
      dx = (joystick.offsetX / joystick.r);
      dy = (joystick.offsetY / joystick.r);
    }

    xPos += dx * vel;
    yPos += dy * vel;
    xPos = constrain(xPos, size/2, width-size/2);
    yPos = constrain(yPos, size/2, height-size/2);

    // Triángulos
    fill(255,0,0);
    for(let i=triangulos.length-1; i>=0; i--){
      let t = triangulos[i];
      t.angle += t.speed;
      let tx = t.centerX + cos(t.angle)*t.radius;
      let ty = t.centerY + sin(t.angle)*t.radius;

      triangle(tx, ty - t.size/2, tx - t.size/2, ty + t.size/2, tx + t.size/2, ty + t.size/2);

      if(dist(xPos, yPos, tx, ty) < size/2 + t.size/2){
        for(let p=0; p<10; p++) {
          particulas.push({x:tx, y:ty, vx:random(-3,3), vy:random(-3,3), a:255});
        }
        triangulos.splice(i,1);
        comidasHechas++;
      }
    }

    // Partículas
    for(let i=particulas.length-1; i>=0; i--){
      let p=particulas[i];
      p.x+=p.vx; p.y+=p.vy; p.a-=10;
      fill(255,0,0,p.a); ellipse(p.x, p.y, 5);
      if(p.a<=0) particulas.splice(i,1);
    }

    // Spawn de oleadas de 10
    if(triangulos.length === 0 && comidasHechas < totalComidas){
      dificultad += 0.15;
      iniciarBloque();
    }

    // Ganar juego
    if(comidasHechas >= totalComidas) ganado = true;

    // Personaje
    rotAngle += 0.05;
    push(); 
    translate(xPos, yPos); 
    rotate(rotAngle);
    rectMode(CENTER); fill(0); 
    rect(0, 0, size, size);
    pop();

    // UI
    noStroke();
    fill(200); rect(20, 20, 200*escalaMovil, 15*escalaMovil);
    fill(255, 0, 0); rect(20, 20, (vida/100)*200*escalaMovil, 15*escalaMovil);
    
    fill(200); rect(20, 45, 200*escalaMovil, 15*escalaMovil);
    fill(0, 200, 0); rect(20, 45, (comidasHechas/totalComidas)*200*escalaMovil, 15*escalaMovil);

    if(esMovil) drawJoystick();

  } else {
    // Pantalla de Fin de Juego (Click para reiniciar)
    background(255);
    imageMode(CENTER);
    let jump = sin(frameCount * 0.1) * 10;
    image(ganado ? gatitoWin : gatitoLose, width/2, height/2, gatitoSize, gatitoSize + jump);
    
    textAlign(CENTER);
    textSize(24 * escalaMovil);
    fill(0);
    text(ganado ? "¡FELICIDADES, GANASTE!" : "GAME OVER", width/2, height/2 + gatitoSize/1.5);
    textSize(16 * escalaMovil);
    text("Toca la imagen para volver a empezar", width/2, height/2 + gatitoSize/1.5 + 30);
  }
}

function drawJoystick(){
  push();
  fill(150, 150, 150, 100);
  ellipse(joystick.x, joystick.y, joystick.r * 2);
  fill(100, 100, 100, 150);
  ellipse(joystick.x + joystick.offsetX, joystick.y + joystick.offsetY, joystick.r);
  pop();
}

function mousePressed() {
  if (ganado || perdido) reiniciarJuego();
}

function touchStarted(){
  if (ganado || perdido) {
    reiniciarJuego();
    return false;
  }
  for(let t of touches){
    if(dist(t.x, t.y, joystick.x, joystick.y) < joystick.r * 2){
      joystick.active = true;
    }
  }
  return false;
}

function touchMoved(){
  if(joystick.active){
    let t = touches[0];
    let d = dist(t.x, t.y, joystick.x, joystick.y);
    let angle = atan2(t.y - joystick.y, t.x - joystick.x);
    let distLimit = min(d, joystick.r);
    
    joystick.offsetX = cos(angle) * distLimit;
    joystick.offsetY = sin(angle) * distLimit;
  }
  return false;
}

function touchEnded(){
  joystick.active = false;
  joystick.offsetX = 0;
  joystick.offsetY = 0;
  return false;
}

function windowResized(){
  resizeCanvas(windowWidth, windowHeight);
  joystick.x = width/2;
  joystick.y = height - (joystick.r + 40);
}

</script>
</body>
</html>